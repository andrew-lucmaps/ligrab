---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


# libraries

```{r}


library(rgrass7)
library(sf)
library(tidyverse)
library(raster)


source("D:/LUCA Team/Land Use Capability Assessments Limited/LUCA Directors - Documents/Code/RCode/ligrab/ligrab_utilities.R")



```

# Setup data directories

```{r}

coderoot = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA Directors - Documents/Code/RCode/ligrab"

dataroot = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/Development Projects/DP-0046-ligrab-R-Development/"


ruleset_folder = paste0(coderoot, "rulesets/")
slopeclass_ruleset_ffname = paste0(ruleset_folder, 'GRASS_reclass_slope-sharnrules_x10.txt')
reliefclass_ruleset_ffname = paste0(ruleset_folder, 'GRASS_r-reclass_rules_Relief_55m_diameter.txt')



gis_dir = paste0(dataroot,"gis/")
if (!dir.exists(gis_dir)){dir.create(gis_dir)}


lig_dir = paste0(gis_dir,"layers/")
if (!dir.exists(lig_dir)){dir.create(lig_dir)}


setwd(wkg_dir)
getwd()  


options(stringsAsFactors = FALSE, scipen = 999)
# library(raster)
# library(sf)

# library(here)




sesh <- sessionInfo()




```

# set up data directories

```{r}

ligrab_subdirs = c(
  "cadastral",
  "orthophoto",
  "catchment",
  "landcover",
  "soil",
  "geology",
  "elevation",
  "localauthorities",
  "climate",
  "derived",
  "LUC",
  "LUS",
  "Other")



for (i in ligrab_subdirs){
  subdir = paste0(lig_dir, i)
  if(!dir.exists(subdir)){dir.create(subdir)}
}


```

# Set up Grass and SAGA Functionality

```{r}


setwd(coderoot)
getwd()
grass_env_code_ffn =   file.path(getwd(), 'env_scripts', 'grass_env.R')
file.exists(grass_env_code_ffn)

source(file = grass_env_code_ffn)

library(rgrass7)

initGRASS(gisBase  = file.path('C:', 'OSGeo4W64', 'apps', 'grass', 'grass78'),
          gisDbase = file.path('D:', 'Grass'),  location = 'ligrab', 
          mapset   = "PERMANENT", override = T)


# library(rgrass7)

Sys.setenv('SAGA' = file.path(Sys.getenv('OSGEO4W_ROOT'), 'apps', 'saga-ltr'))
Sys.setenv('PATH' = paste(Sys.getenv("PATH"),
                          file.path(Sys.getenv('SAGA')),
                          file.path(Sys.getenv('SAGA'), 'modules'),
                          sep = .Platform$path.sep))


```



# Step 1. Copy the DEM to the elevation directory

```{r}




dem.in = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/2021-07-10-LP0038-R_Hart/GIS/Grid rasters - covariates/2021_DEM_LiDAR_Omakere_HBRC/merged.tif"

ff.out = paste0(lig_dir, "elevation/DEM_1m.tif")

#read the raster file
ligrg.readraster(ff.in = dem.in, obj.out = 'DEM_in')

#save it to the elevation directory
ligrg.saveraster(obj.in = 'DEM_in', ff.out = ff.out)



```

# Step 2. Resample the Raster

```{r}

target_res = 5

ff.in = paste0(lig_dir, "elevation/DEM_1m.tif")
ff.out = paste0(lig_dir, "elevation/DEM_resamp_",target_res,"m.tif")

src_obj_name = 'dem'
dst_obj_name = 'dem_res'

#read the raster file
ligrg.readraster(ff.in = dem.in, obj.out = src_obj_name)

#resample to 15m
ligrg.resample(obj.in = src_obj_name, obj.out = dst_obj_name, target_res)

#save the resampled raster
ligrg.saveraster(obj.in = dst_obj_name, ff.out = ff.out)

```

# Step 3. denoise the resampled DEM

```{r}

target_res = 5

ff.in = paste0(lig_dir, "elevation/DEM_resamp_",target_res,"m.tif")
ff.out = paste0(tools::file_path_sans_ext(ff.in),"_DN.tif")

ligrg.sagadenoise(ff.in = ff.in, ff.out =ff.out )


```

# Step 4. Get the slope classes

```{r}



# now calculate the slope classes

ff.in = paste0(lig_dir, "elevation/DEM_resamp_",target_res,"m_DN.tif")
dir.out = paste0(dirname(ff.in),"/")
focal_med_size = 11

ligrg.slopeclasses(ff.in, dir.out, focal_med_size = 11)

```

# Step 5. Get the relief classes

```{r}



# now calculate the slope classes

ff.in = paste0(lig_dir, "elevation/DEM_resamp_",target_res,"m_DN.tif")
focal_med_size = 11

ligrg.reliefclasses(ff.in,  focal_med_size = focal_med_size)


```

# Step 6. Do the RMS Calculation

```{r}


# relief.class.ff.in = paste0("D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/Development Projects/DP-0046-ligrab-R-Development/gis/layers/elevation/relief_classes_d11.tif")
# 
# slope.class.ff.in = paste0(("D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/Development Projects/DP-0046-ligrab-R-Development/gis/layers/elevation/slope_classes_d11.tif"))

focal_size = 11

relief.class.ff.in = paste0(lig_dir, "elevation/relief_classes_d",focal_size,".tif")
slope.class.ff.in = paste0(lig_dir, "elevation/slope_classes_d",focal_size,".tif")
# ff.out = paste0(lig_dir, "elevation/RMS_d",focal_size,".tif")

ligrg.RMS(relief.class.ff.in, slope.class.ff.in, focal_size = 11, area_thresh)
  

```


# Step 8 Slope Length
```{r}


dem.in = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/2021-07-10-LP0038-R_Hart/GIS/layers/elevation/DEM_resamp_5m.tif"

ligrsaga.slopelength(dem.in)



```








# Step 1. Copy the DEM to the elevation directory

```{r}


```

# Step 1. Copy the DEM to the elevation directory

```{r}


```

```{r}



# now calculate the slopes

ff.in = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/Development Projects/DP-0046-ligrab-R-Development/gis/layers/elevation/DEM_15m.tif"

dir.out = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/Development Projects/DP-0046-ligrab-R-Development/gis/layers/elevation/"

focal_med_size = 11

ligrg.slopeclasses(ff.in, dir.out, focal_med_size = 11)

# now calculate the relief classes

ligrg.reliefclasses(ff.in, ff.out = NULL, focal_med_size = 11, reliefclass_ruleset = reliefclass_ruleset)

```


# Old Step 1 Import a DEM

```{r}

#=====================
# Step 1. Import DEMS
#=====================

# root = 'D:/sharns/SFM_exports/DTM'
# dem = 'D:/sharns/SFM_exports/DTM/Sharn_DTM_1m_v1A_2193.tif'

root = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/2021-07-10-LP0038-R_Hart/GIS/Grid rasters - covariates/2021_DEM_LiDAR_Omakere_HBRC"
dem = "D:/LUCA Team/Land Use Capability Assessments Limited/LUCA team site - Documents/LUCA-A/Projects/2021-07-10-LP0038-R_Hart/GIS/Grid rasters - covariates/2021_DEM_LiDAR_Omakere_HBRC/merged.tif"


execGRASS('r.in.gdal',
          input = dem,
          output = 'DEM_1m',
          flags = c('e', 'overwrite'))


# create a region from the imported file  
  execGRASS('g.region', raster = 'DEM_1m')




```



# Old Step 2 Resample DEM to desired Scale

```{r}


# make the resolution of the imported refion be 5 m
execGRASS('g.region', res = '5', flags = c('a'))

# r.resamp.stats: Resamples raster map layers to a coarser grid using aggregation

#resample 1m DEM to 5m  
execGRASS('r.resamp.stats',
          input = 'DEM_1m',
          output ='DEM_5m',
          method = 'median',
          flags = 'overwrite')


```

# Old Step 3 Save the File 

```{r}

#save the DEM
execGRASS('r.out.gdal', 
          input = "DEM_5m",
          output = file.path(root, 'DEM_5m.tif'),
          format = 'GTiff', flags = c('c', 'overwrite'),
          createopt = c('COMPRESS=DEFLATE','TILED=YES'))

#  # set the region (is this nec?)  
# execGRASS('g.region', raster = 'DEM_1m')


```

